%% Types
\newcommand{\trm}[1]{\mathbb{E}#1}
\newcommand{\one}{\mathbb{1}}
\newcommand{\base}{\mathbb{B}}
\newcommand{\arrow}[2]{#1\rightarrow#2}
\newcommand{\product}[2]{#1\times#2}
\newcommand{\coproduct}[2]{#1+#2}

%% Expressions
\newcommand{\key}{\mathbf}

\newcommand{\app}{\;}

\newcommand{\expvar}[1]{#1}

\newcommand{\expconst}[2]{#1~#2}
\newcommand{\expunit}{()}
\newcommand{\explit}[2]{\key{l}_{#1}\,#2}
\newcommand{\expabs}[3]{\lambda#1.\,#3}
\newcommand{\expapp}[2]{#1\app#2}
\newcommand{\exppair}[2]{(#1,#2)}
\newcommand{\expfst}[1]{\pi_1~#1}
\newcommand{\expsnd}[1]{\pi_2~#1}
\newcommand{\expinl}[1]{\iota_1~#1}
\newcommand{\expinr}[1]{\iota_2~#1}
\newcommand{\expcase}[3]{\delta\app#1\app#2\app#3}

%% Meta language stuff
\newcommand{\subst}[3]{#1[#2:=#3]}
\newcommand{\fv}[1]{\mathit{FV}(#1)}
\newcommand{\rewrite}[1]{\mathbin{\mapsto_{#1}}}
\newcommand{\hole}{[~]}

%% Typing
\newcommand{\intro}{\mathcal{I}}
\newcommand{\elim}{\mathcal{E}}
\newcommand{\inference}[3]{\infer[\mathsf{#2}]{#3}{#1}}

\newcommand{\figterm}{
\begin{figure*}[t]
\[
\begin{array}{l@@{\quad}rcl}
\text{Types} & A,B,C & ::=&
  \base           \mid
  \one            \mid
  \arrow{A}{B}    \mid
  \product{A}{B}  \mid
  \coproduct{A}{B}
\\[1ex]
\text{Terms} & L,M,N & ::= &
  \expvar{x}              	\mid
  \expconst{c}{\overline{M}}	\mid
  \expabs{x}{A}{N}              \mid
  \expapp{L}{M}                 \mid
  \explet{x}{M}{N}              \mid
  \exppair{M}{N}                \mid
  \expfst{L}                   	\mid
  \expsnd{L}                    \mid \\&&&
  \expinl{M}	        	\mid
  \expinr{N}           	        \mid
  \expcase{L}{M}{N}
\\[1ex]
\text{Values} & V,W & ::= &
  \expvar{x}       \mid
  \expabs{x}{A}{N} \mid
  \exppair{V}{W}   \mid
  \expinl{V}{B}    \mid
  \expinr{A}{W}
% \\[1ex]
% \text{Non-Values} & P & ::= &
%   \expconst{c}{\overline{M}}  \mid
%   \expapp{L}{M}               \mid
%   \explet{x}{M}{N}            \mid
%   \exppair{P}{N}              \mid
%   \exppair{V}{P}              \mid
%   \expfst{P}                  \mid
%   \expsnd{P}                  \mid \\&&&
%   \expinl{P}{\tm{B}}          \mid
%   \expinr{\tm{A}}{P}          \mid
%   \expcase{L}{x}{M}{y}{N}
\end{array}
\]

\caption{Types and Terms}
\label{fig:term}
\end{figure*}
}


\newcommand{\fignorm}{
\begin{figure*}[t]
Phase 1 (let-insertion)
\[
  \begin{array}{lcl}
   F &\mathbin{::=}&
%      c \app \overline{V} \app \hole \app \overline{N} \mid
       \expapp{\hole}{M}                                \mid
       \expapp{V}{\hole}                                \mid
       \exppair{\hole}{M}                               \mid
       \exppair{V}{\hole}                               \mid
       \expfst{\hole}                                   \mid
       \expsnd{\hole}                                   \mid % \\ &&
       \expinl{\hole}{B}                                \mid
       \expinr{A}{\hole}                                \mid
       \expcase{\hole}{x}{M}{y}{N} \\
 \end{array}
\]%
\[
\begin{array}{lllll}
(\mathit{let})
& F[M]
& \rewrite{1}
& \explet{x}{M}{F[x]},
& \text{$x$ fresh, $M$ not a value}
\end{array}
\]

\vspace{2ex}

Phase 2 (symbolic evaluation)
\[
G \mathbin{::=}
    %\expapp{\hole}{V} \mid
    \explet{x}{\hole}{N}
\]
\[
\begin{array}{lllll}
%% SL: given that G now only has one case we could use the
%% explicit versions of the $\kappa$-rules, but actually I think
%% this version is harder to read.
%%
%% (\kappa.{\mathit{let}})
%% & \explet{y}{\explet{x}{L}{M}}{N}
%% & \rewrite{2}
%% & \explet{x}{L}{\explet{y}{M}{N}},
%% & x \notin \fv{M} \\
%%
%% (\kappa.{\mathit{case}})
%% & \explet{z}{\expcase{L}{x}{M}{y}{M'}}{N}
%% & \rewrite{2}
%% & \expcase{L}{x}{\explet{z}{M}{N}}{y}{\explet{z}{M'}{N}},
%% & x,y \notin \fv{N} \\

(\kappa.{\mathit{let}})
& G[\explet{x}{M}{N}]
& \rewrite{2}
& \explet{x}{M}{G[N]},
& x \notin \fv{G} \\

(\kappa.{\mathit{case}})
& G[\expcase{V}{x}{M}{y}{N}]
& \rewrite{2}
& \expcase{V}{x}{G[M]}{y}{G[N]},
& x,y \notin \fv{G} \\

% (\kappa.{\mathit{case}})
% & G[\expcase{z}{x}{M}{y}{N}] & \rewrite{2}\\
% \multicolumn{3}{@@{}l@@{}}
% {\qquad\qquad\qquad\quad \expcase{z}{x}{G[M]}{y}{G[N]},} & \quad x,y \notin \fv{G} \\[1ex]

(\beta.{\rightarrow})
& \expapp{(\expabs{x}{A}{N})}{V}
& \rewrite{2}
& \subst{N}{x}{V} \\

(\beta.{\times_1})
& \expfst{\exppair{V}{W}}
& \rewrite{2}
& V \\

(\beta.{\times_2})
& \expsnd{\exppair{V}{W}}
& \rewrite{2}
& W \\

(\beta.{+_1})
& \expcase{(\expinl{V}{B})}{x}{M}{y}{N}
& \rewrite{2}
& \subst{M}{x}{V} \\

(\beta.{+_2})
& \expcase{(\expinr{A}{W})}{x}{M}{y}{N}
& \rewrite{2}
& \subst{N}{y}{W} \\

(\beta.{\mathit{let}})
& \explet{x}{V}{N}
& \rewrite{2}
& \subst{N}{x}{V} \\
\end{array}
\]

\vspace{2ex}

Phase 3 (garbage collection)
\[
\begin{array}[t]{@@{}llll@@{\quad}l@@{}}

(\mathit{need})
& \explet{x}{M}{N}
& \rewrite{3}
& N,
& x \notin \fv{N}\\
%% & \subst{N}{x}{P},
%% & Count(x,N) < 2 \\
\end{array}
\]

\caption{Normalisation Rules}
\label{fig:norm}
\end{figure*}
}
